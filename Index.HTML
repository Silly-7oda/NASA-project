<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meteor Dive — NEO Simulator</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --accent:#7c5cff; --muted:#9aa4b2; --glass: rgba(255,255,255,0.03);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07101a);color:#e6eef6}
  .wrap{display:grid;grid-template-columns:380px 1fr;gap:20px;padding:18px;height:100%;box-sizing:border-box}
  .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.6);overflow:auto}
  h1{margin:0 0 8px;font-size:20px}
  label{display:block;font-size:12px;color:var(--muted);margin-top:12px}
  input[type="date"],input[type="text"],select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:var(--glass);color:inherit;box-sizing:border-box}
  button{margin-top:12px;width:100%;padding:10px;border-radius:10px;border:none;background:var(--accent);color:#07101a;font-weight:700;cursor:pointer}
  button:hover{opacity:0.9}
  .small{font-size:13px;color:var(--muted)}
  #canvasWrap{position:relative;height:100%;display:flex;flex-direction:column}
  canvas{flex:1;border-radius:12px;background:linear-gradient(#07101a,#07202a);display:block;width:100%}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;font-size:13px;white-space:nowrap}
  .neo-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto}
  .neo-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .neo-item button{padding:6px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);margin:0;width:auto}
  .neo-item button:hover{background:rgba(255,255,255,0.05)}
  footer{font-size:12px;color:var(--muted);margin-top:10px}
  @media (max-width:900px){.wrap{grid-template-columns:1fr;grid-auto-rows: min-content 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" style="height:100%;">
    <h1>Meteor Dive — NEO Simulator</h1>
    <div class="small">Fetch NEO (near-earth objects) from NASA's NEO feed and simulate impacts.</div>

    <label>Start date</label>
    <input id="startDate" type="date" value="2025-10-01" />

    <label>End date</label>
    <input id="endDate" type="date" value="2025-10-03" />

    <label class="small">Fetch options</label>
    <div style="display:flex;gap:8px;">
      <button id="fetchBtn">Fetch meteors</button>
      <button id="clearBtn" style="background:#263347">Clear</button>
    </div>

    <div class="controls">
      <div class="chip">Speed: <input id="speed" type="range" min="0.2" max="5" step="0.2" value="1" style="width:100px;margin-left:8px"></div>
      <div class="chip">Labels: <input id="labels" type="checkbox" checked style="margin-left:8px"></div>
      <div class="chip">Gravity: <input id="gravity" type="range" min="0.1" max="3" step="0.1" value="1" style="width:100px;margin-left:8px"></div>
    </div>

    <label class="small">Objects found (<span id="neoCount">0</span>)</label>
    <div id="neoList" class="neo-list"></div>

    <footer>Tip: click an object to spawn it directly into the simulation.</footer>
  </div>

  <div id="canvasWrap" class="panel">
    <canvas id="simCanvas"></canvas>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button id="playPause" style="flex:1;min-width:120px">Play</button>
      <button id="spawnRandom" style="flex:1;min-width:150px">Spawn random NEO</button>
      <div class="chip" id="status" style="flex:1;min-width:150px">Status: idle</div>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const neoListEl = document.getElementById('neoList');
const neoCountEl = document.getElementById('neoCount');

let neoData = [];
let particles = [];
let earth = { x: 0, y: 0, radius: 80 };
let isPlaying = false;
let animationId = null;

// State
let showLabels = true;
let speedMultiplier = 1;
let gravityMultiplier = 1;

function status(msg) {
  statusEl.textContent = 'Status: ' + msg;
}

function resizeCanvas() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  earth.x = canvas.width / 2;
  earth.y = canvas.height / 2;
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Fetch NEO data from NASA API
async function fetchNEO(start, end) {
  status('fetching NEOs...');
  try {
    const API_KEY = 'xMwbvnOwqnQ1vHmWMsRFZHU8TGOZpKFwDoW4Wvi1';
    const url = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${start}&end_date=${end}&api_key=${API_KEY}`;
    const res = await fetch(url);
    
    if (res.status === 429) {
      status('rate limit exceeded - try again in a minute or use your own NASA API key');
      alert('NASA API rate limit exceeded. The DEMO_KEY allows 30 requests per hour.\n\nSolutions:\n1. Wait a few minutes and try again\n2. Get a free API key at https://api.nasa.gov\n3. Try a shorter date range (1-2 days)');
      return [];
    }
    
    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }
    
    const data = await res.json();
    const neo_by_date = data.near_earth_objects || {};
    const neos = [];
    Object.keys(neo_by_date).forEach(date => {
      neo_by_date[date].forEach(n => neos.push(n));
    });
    status(`fetched ${neos.length} objects`);
    return neos;
  } catch (err) {
    status('fetch error: ' + err.message);
    console.error(err);
    return [];
  }
}

// UI handlers
document.getElementById('fetchBtn').addEventListener('click', async () => {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  if (!start || !end) {
    status('please select dates');
    return;
  }
  neoData = await fetchNEO(start, end);
  updateNEOList();
});

document.getElementById('clearBtn').addEventListener('click', () => {
  neoData = [];
  particles = [];
  updateNEOList();
  status('cleared');
});

document.getElementById('playPause').addEventListener('click', () => {
  isPlaying = !isPlaying;
  document.getElementById('playPause').textContent = isPlaying ? 'Pause' : 'Play';
  if (isPlaying) {
    animate();
  }
});

document.getElementById('spawnRandom').addEventListener('click', () => {
  if (neoData.length === 0) {
    status('no NEO data - fetch first');
    return;
  }
  const neo = neoData[Math.floor(Math.random() * neoData.length)];
  spawnParticle(neo);
});

document.getElementById('speed').addEventListener('input', (e) => {
  speedMultiplier = parseFloat(e.target.value);
});

document.getElementById('gravity').addEventListener('input', (e) => {
  gravityMultiplier = parseFloat(e.target.value);
});

document.getElementById('labels').addEventListener('change', (e) => {
  showLabels = e.target.checked;
});

function updateNEOList() {
  neoCountEl.textContent = neoData.length;
  neoListEl.innerHTML = '';
  neoData.slice(0, 20).forEach((neo, idx) => {
    const div = document.createElement('div');
    div.className = 'neo-item';
    const name = neo.name || 'Unknown';
    const diameter = neo.estimated_diameter?.kilometers?.estimated_diameter_max || 0;
    div.innerHTML = `
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
        <div style="font-size:11px;color:var(--muted)">${diameter.toFixed(2)} km diameter</div>
      </div>
      <button onclick="spawnByIndex(${idx})">Spawn</button>
    `;
    neoListEl.appendChild(div);
  });
  if (neoData.length > 20) {
    const more = document.createElement('div');
    more.className = 'small';
    more.style.padding = '8px';
    more.textContent = `...and ${neoData.length - 20} more`;
    neoListEl.appendChild(more);
  }
}

window.spawnByIndex = function(idx) {
  if (neoData[idx]) {
    spawnParticle(neoData[idx]);
    if (!isPlaying) {
      isPlaying = true;
      document.getElementById('playPause').textContent = 'Pause';
      animate();
    }
  }
};

function spawnParticle(neo) {
  const angle = Math.random() * Math.PI * 2;
  const distance = Math.max(canvas.width, canvas.height) * 0.6;
  const diameter = neo.estimated_diameter?.kilometers?.estimated_diameter_max || 0.1;
  const size = Math.max(3, Math.min(20, diameter * 5));
  
  const velocity = neo.close_approach_data?.[0]?.relative_velocity?.kilometers_per_second || 10;
  const speed = Math.min(5, velocity / 5);

  particles.push({
    x: earth.x + Math.cos(angle) * distance,
    y: earth.y + Math.sin(angle) * distance,
    vx: -Math.cos(angle) * speed * 0.5,
    vy: -Math.sin(angle) * speed * 0.5,
    size: size,
    name: neo.name || 'Unknown',
    color: `hsl(${Math.random() * 60 + 180}, 70%, 60%)`,
    trail: []
  });
  
  status(`spawned ${neo.name}`);
}

function animate() {
  if (!isPlaying) return;
  
  ctx.fillStyle = 'rgba(7, 16, 26, 0.2)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Draw Earth
  const grad = ctx.createRadialGradient(earth.x, earth.y, 0, earth.x, earth.y, earth.radius);
  grad.addColorStop(0, '#4a9eff');
  grad.addColorStop(0.7, '#2563eb');
  grad.addColorStop(1, '#1e3a8a');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(earth.x, earth.y, earth.radius, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw atmosphere glow
  ctx.strokeStyle = 'rgba(74, 158, 255, 0.3)';
  ctx.lineWidth = 8;
  ctx.beginPath();
  ctx.arc(earth.x, earth.y, earth.radius + 10, 0, Math.PI * 2);
  ctx.stroke();

  // Update and draw particles
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    
    // Handle lifetime for explosion particles
    if (p.lifetime !== undefined) {
      p.lifetime--;
      if (p.lifetime <= 0) {
        particles.splice(i, 1);
        continue;
      }
    }
    
    // Add to trail (only for NEO particles, not explosion debris)
    if (p.lifetime === undefined) {
      p.trail.push({ x: p.x, y: p.y });
      if (p.trail.length > 30) p.trail.shift();
      
      // Draw trail
      ctx.strokeStyle = p.color + '40';
      ctx.lineWidth = 2;
      ctx.beginPath();
      if (p.trail.length > 1) {
        ctx.moveTo(p.trail[0].x, p.trail[0].y);
        for (let j = 1; j < p.trail.length; j++) {
          ctx.lineTo(p.trail[j].x, p.trail[j].y);
        }
        ctx.stroke();
      }
    }
    
    // Calculate gravity (only for NEO particles)
    if (p.lifetime === undefined) {
      const dx = earth.x - p.x;
      const dy = earth.y - p.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const force = (gravityMultiplier * 0.5) / (dist * dist) * 10000;
      
      p.vx += (dx / dist) * force * speedMultiplier;
      p.vy += (dy / dist) * force * speedMultiplier;
      
      // Check collision
      if (dist < earth.radius + p.size) {
        createImpact(p.x, p.y, p.size);
        particles.splice(i, 1);
        status(`${p.name} impacted!`);
        continue;
      }
    }
    
    p.x += p.vx * speedMultiplier;
    p.y += p.vy * speedMultiplier;
    
    // Draw particle with fade for explosion particles
    const alpha = p.lifetime !== undefined ? p.lifetime / 60 : 1;
    ctx.globalAlpha = alpha;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
    
    // Draw label (only for NEO particles)
    if (showLabels && p.name && p.lifetime === undefined) {
      ctx.fillStyle = '#fff';
      ctx.font = '11px Inter, sans-serif';
      ctx.fillText(p.name, p.x + p.size + 5, p.y - 5);
    }
    
    // Remove if off screen
    if (p.x < -100 || p.x > canvas.width + 100 || p.y < -100 || p.y > canvas.height + 100) {
      particles.splice(i, 1);
    }
  }
  
  animationId = requestAnimationFrame(animate);
}

function createImpact(x, y, size) {
  const impactParticles = 20;
  for (let i = 0; i < impactParticles; i++) {
    const angle = (Math.PI * 2 * i) / impactParticles;
    const speed = Math.random() * 3 + 2;
    particles.push({
      x: x,
      y: y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: Math.random() * 3 + 1,
      name: '',
      color: '#ff6b35',
      trail: [],
      lifetime: 60
    });
  }
}

// Initial state
status('idle - select dates and fetch NEOs');
</script>
</body>
</html>
